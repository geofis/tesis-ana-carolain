---
title: "Pefiles de elevación"
author: "Ana Valera, Carolain Pérez, Yulisa Arias, José Martínez (tali)"
date: '2023-02-16'
output:
  pdf_document
  # github_document
editor_options: 
  chunk_output_type: console
  keep_tex: true
  pandoc_args: ["--pdf-engine=xelatex"]
header-includes:
  - \usepackage{geometry}
  - \geometry{landscape=true, margin=1in}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = F, message = F, warning = F, fig.width = 11, fig.height = 8)
```

# Perfiles de elevación

## Cargar paquetes y funciones


```{r}
library(raster)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(topoDistance)
library(kableExtra)
options(knitr.kable.NA = '')
my_kable_style <- function(df, caption = '', full_width = T) {
  df %>% kable(format = 'latex', escape = F, booktabs = T,
               digits = 2, caption = caption) %>%
    kable_styling(bootstrap_options = c("hover", "condensed"),
                  latex_options = "HOLD_position",
                  full_width = full_width, position = "center")
}
source('R/funciones.R')
```

Datos

```{r}
transectos <- st_read('transectos-perfiles-de-elevacion/transectos-perfiles-elevacion.gpkg') %>% 
  arrange(nombre, ID)
dsm <- raster('transectos-perfiles-de-elevacion/dsm_hires.tif')
```

Algunas pruebas:

```{r}
# topoProfile(dsm, transectos %>% as_Spatial() %>% as('SpatialLines'))
# topoProfile(dsm, transectos[1:6,] %>% as_Spatial() %>% as('SpatialLines'), type = 'plotly')
```

```{r mapadetransectos, echo=F, out.extra='clip', fig.cap='Mapa de localización de transectos para perfiles de playa'}
knitr::include_graphics("mapa-de-transectos-perfiles-de-elevacion.jpg", dpi = 250)
```


```{r, fig.width=16, dpi=72, fig.cap='Perfiles de playa por sectores, desagregados'}
lista_datos <- miTopoProfile(dsm, transectos %>% as_Spatial() %>% as('SpatialLines')) %>% 
  setNames(paste(transectos$nombre, transectos$ID, sep = '-'))
tabla_datos <- plyr::ldply(lista_datos, .id = 'sector_ID') %>% 
  mutate(Sector = gsub('(.*)-(.)*', '\\1', sector_ID),
         ID = as.numeric(gsub('(.*)-(.*)', '\\2', sector_ID))) %>% 
  mutate(ID = factor(ID, levels = sort(unique(ID)))) %>% 
  rename(`Distancia (adimensional)` = Distance, `Elevación (adimensional)` = Elevation)
tabla_datos %>%
  ggplot() +
  aes(x = `Distancia (adimensional)`, y = `Elevación (adimensional)`) +
  geom_line(alpha = 0.5, color = 'grey50') +
  geom_smooth(se = F, color = 'black') + 
  scale_x_continuous(breaks = c(0,0.5,1), labels = c(0,0.5,1), limits = c(0, 1)) +
  scale_y_continuous(breaks = c(0,0.5,1), labels = c(0,0.5,1), limits = c(0, 1)) +
  theme(
    legend.position = "none",
    text = element_text(size = 12),
    panel.background = element_rect(fill = 'white', colour = NA),
    panel.grid.major.y = element_line(colour = "grey", linetype = "dashed", size = 0.25),
    strip.background = element_rect(colour = "grey90", fill = "grey90"),
    panel.border = element_rect(color = NA, fill = NA, size = 1),
    strip.text = element_text(colour = "black", size = 10)
    ) +
  facet_wrap( ~ sector_ID, ncol = 9)
```


```{r, fig.width=16, dpi=72, fig.cap='Perfiles de playa por sectores, combinados'}
tabla_datos %>%
  ggplot() +
  aes(x = `Distancia (adimensional)`, y = `Elevación (adimensional)`, group = ID, color = ID) +
  geom_line(alpha = 0.5, color = 'grey50') +
  geom_smooth(se = F) + 
  scale_x_continuous(breaks = c(0,0.5,1), labels = c(0,0.5,1), limits = c(0, 1)) +
  scale_y_continuous(breaks = c(0,0.5,1), labels = c(0,0.5,1), limits = c(0, 1)) +
  theme(
    text = element_text(size = 14),
    panel.background = element_rect(fill = 'white', colour = NA),
    panel.grid.major.y = element_line(colour = "grey", linetype = "dashed", size = 0.25),
    strip.background = element_rect(colour = "grey90", fill = "grey90"),
    panel.border = element_rect(color = NA, fill = NA, size = 1),
    strip.text = element_text(colour = "black", size = 12)
    ) +
  facet_wrap( ~Sector)
```
